---
layout: post
title: "Ubuntu 22.04 LTS へのアップデートに失敗した"
tags : [Linux, 環境構築]
date: 2022-11-24 20:32:44
---


普段使っているUbuntuは20.04 LTSだったので、
そろそろ22.04 LTSにしようかと思った。

18.04 LTSからアップデートしたときは特に問題なかったから、
今回もいけるだろって思ってバックアップなどとらずに普通にUbuntuソフトウェアセンターからやった。

ダウンロードやインストール含め、5時間ぐらいって出ている。

いやに長いなと思って、
そのまま一晩ほっといて、朝起きたら、
faildeの文字が。。。

まじかー。
何が悪いんだろう。
まあ、いいや、とりあえず再起動してみよう。




・・・あれ、上がらない。。。

まじかー、アップデート失敗で起動しなくなってしまった。
何度か再起動したり、GRUBのsafe modeから、Linuxのカーネルのバージョンさげて起動したりしても、だめ。

GUIが全く立ち上がらなくて、画面にはなんかメッセージが出ているのみ。
USBが認識できていない的なメッセージが多くて、あまり見てなかったけど、
そのメッセージをよく読んでみると、

「contains a file system with errors」

と出ている。
ファイルシステムが壊れた？
メッセージでググってみると、

[Ubuntuが「contains a file system with errors」と出て起動しなくなったときの対処法 &#124; Harukaのガラクタ箱](https://techblog.nullstack.engineer/entry/ubuntu_filesystem-error/)

がひっかかる。

で、ここに載っている画像と同じく
「RUN fsck MANUALLY」
のメッセージも出ていたので、

[システム起動時にUNEXPECTED INCONSISTENCYエラーが発生した場合は － ＠IT](https://atmarkit.itmedia.co.jp/flinux/rensai/linuxtips/974fsck.html)

上記のように、fsckを実施。

```bash
# マウントされているパーティションを一覧化
$ mount

# Ubuntuが入っているファイルシステムを修復 -tは、ext3でフォーマットしていたため
$ fsck -t ext3 /dev/sdb1
```


これで多少待つと無事に終わって、inodeが結構直されていた。
やっぱりアップデート失敗によりなにか壊れていたかな。


そこから再起動したら、
なんとなく画面の解像度が変わったような気がするが、
やっぱりログイン画面は出ずに、USB認識していないエラーのみ。

なお、CUIモードは、Ctrl + Alt + F1で入れているので、
これは、GUIだけが反応してないのかなと思い、
Xorgの設定ファイルを色々みたり、情報探して直してみたりしたけど、全然だめ。


色々やってたら、
「Kernel panic」
とかも出てきて、困った。

このまま頑張って解決してもいいんだけど、
そうしても、また 22.04のアップデートで失敗することも考えられたので、

それだったら、Ubuntu をクリーンインストールするかと思った。
確か16.04 LTSいれたときも同じようなことした覚えがある。

ただし、20.04 LTSの中のデータはバックアップしないといけないので、
別パーティションに入っているUbuntu 9.04 を起動しようとしたけど、全然動かなかった。
このUbuntu、ただのデータ置き場としか使ってないからなー。

ということで、別PCで、Ubuntu 22.04 LTSのライブUSBメモリーを作って、
一時的に動くUbuntuを手に入れることにした。
やり方は下記（僕はWindows 10 でやった

[Ubuntu 22.04 その64 - Windows/Linux/macOSでUbuntu 22.04 LTSのライブUSBメモリーを作るには - kledgeb](https://kledgeb.blogspot.com/2022/04/ubuntu-2204-64-windowslinuxmacosubuntu.html)


ライブCD-Rにしなかったのは、
DVDドライブがなんか調子悪かったから。


ライブUSBができたら、PCに指して、
BIOSメニューから、USBから起動するように指定。

そして、再起動して、なんとか
Try Ubuntu と Install Ubuntu の選択肢の画面までたどり着く。


Try Ubuntuで、ためしに使ってみたら
20.04 LTSが入っていたパーティション（/dev/sdb1）からもちゃんとデータをバックアップすることができた。


で、バックアップが終わったら、
再起動して今度はInstall Ubuntu からインストールを進める。

ただし、Ubuntu 22.04では「EFIシステムパーティション」というパーティションがひつようになったみたい。

[Ubuntu 22.04 LTSのインストール その5 - UEFI環境でパーティションの作成と構成 〜 ブートローダーのインストール先の選択 - kledgeb](https://kledgeb.blogspot.com/2022/04/ubuntu-2204-lts-5-uefi.html)


インストール途中で、パーティションを自分でいじるタイミングでパーティション編集に入り、
/dev/sdb1 をext4でフォーマットするのと、
今までスワップパーティションとしていた領域をEFIシステムパーティションに変更。

ちなみに、スワップパーティション、今までは10GBとっていたが、
EFIシステムパーティションは512MBでいいってことなので、縮めたかったが、
ここを縮めてもその前にWindowsが居座っていたから、断念。
そのまま10GBとした。


住んでる場所は東京にしたけど、
言語を英語にしてインストール。

インストール自体はたぶん1時間ぐらい。


軽く動かしたら問題なさそうだった。
ソフトは色々入れ直さないといけないけど、まあいい機会か。




教訓


Ubuntuアップデートする際は、やっぱりバックアップは取っておこうぜ。




